<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle=${titulo}, content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>

<main class="container-fluid p-4 animate__animated animate__fadeIn" id="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0 text-primary" th:text="${titulo}"></h3>
        <a th:href="@{/admin}" class="btn btn-outline-secondary rounded-pill px-4 py-2 fw-bold">
            ← Volver al Panel
        </a>
    </div>

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-4">

            <form th:object="${coleccionDTO}"
                  th:action="${accion == 'crear'} ? @{/admin/colecciones/crear} : @{/admin/colecciones/{id}/editar(id=${coleccionDTO.handleID})}"
                  method="post">

                <div class="mb-3">
                    <label for="titulo" class="form-label">Título</label>
                    <input type="text" id="titulo" class="form-control" th:field="*{titulo}" required>
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripción</label>
                    <textarea id="descripcion" class="form-control" rows="4" th:field="*{descripcion}" required></textarea>
                </div>

                <div class="mb-4">
                    <label for="algoritmoConsenso" class="form-label">Algoritmo de Consenso</label>
                    <select id="algoritmoConsenso" class="form-select" th:field="*{algoritmoConsenso}" required>
                        <option value="">Seleccione un algoritmo...</option>
                        <option th:each="entry : ${consensusLabels}"
                                th:value="${entry.key}"
                                th:text="${entry.value}">
                        </option>
                    </select>
                </div>

                <div class="mb-4 p-3 bg-light rounded border">
                    <label class="form-label fw-bold">Fuentes de Datos</label>
                    <div class="d-flex gap-3">
                        <div class="form-check" th:each="fuente : ${fuentesDisponibles}">
                            <input class="form-check-input" type="checkbox"
                                   name="fuentes"
                                   th:value="${fuente}"
                                   th:id="${'fuente-' + fuente}"
                                   th:checked="${coleccionDTO.fuentes != null and #lists.contains(coleccionDTO.fuentes, fuente)}">
                            <label class="form-check-label" th:for="${'fuente-' + fuente}" th:text="${fuente}"></label>
                        </div>
                    </div>
                    <div class="form-text">Seleccione de dónde obtendrá datos esta colección.</div>
                </div>

                <div class="mb-4">
                </div>

                <div class="mb-4 p-3 bg-light rounded border">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold mb-0">Criterios de Pertenencia</label>
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" onclick="agregarCriterio()">
                            <i class="bi bi-plus-lg"></i> Agregar Criterio
                        </button>
                    </div>
                    <div class="form-text mb-3">Defina reglas para filtrar qué hechos entran automáticamente.</div>

                    <div id="criterios-container">
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a th:href="@{/admin}" class="btn btn-secondary rounded-pill px-4">Cancelar</a>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">
                        <span th:text="${accion == 'crear'} ? 'Crear Colección' : 'Guardar Cambios'"></span>
                    </button>
                </div>

            </form>
        </div>
    </div>
</main>

<div id="page-scripts">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('admin');
            cargarCriteriosExistentes();
        });
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Traemos las listas desde Java a JS
        const listaCategorias = /*[[${listaCategorias}]]*/ [];
        const listaProvincias = /*[[${listaProvincias}]]*/ [];
        const criteriosOps = /*[[${criteriosDisponibles}]]*/ ['TITULO', 'CATEGORIA', 'UBICACION', 'FECHA'];
        const criteriosNombresPrevios = /*[[${coleccionDTO.criteriosPertenenciaNombres}]]*/ [];
        const criteriosValoresPrevios = /*[[${coleccionDTO.criteriosPertenenciaValores}]]*/ [];
        /*]]>*/

        function cargarCriteriosExistentes() {
            if (criteriosNombresPrevios && criteriosNombresPrevios.length > 0) {
                for (let i = 0; i < criteriosNombresPrevios.length; i++) {
                    // Llamamos a agregarCriterio pasando los valores que ya tenemos
                    agregarCriterio(criteriosNombresPrevios[i], criteriosValoresPrevios[i]);
                }
            }
        }

        function agregarCriterio(tipoPreseleccionado = null, valorPreseleccionado = null) {
            const container = document.getElementById('criterios-container');
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 align-items-center criterio-row animate__animated animate__fadeIn';

            let optionsHtml = '';
            criteriosOps.forEach(op => {
                // Si estamos cargando datos, marcamos el option como selected
                const selected = (tipoPreseleccionado && op === tipoPreseleccionado) ? 'selected' : '';
                optionsHtml += `<option value="${op}" ${selected}>${op}</option>`;
            });

            row.innerHTML = `
            <div class="col-4">
                <select class="form-select form-select-sm selector-tipo" name="criteriosPertenenciaNombres" onchange="cambiarInputValor(this)">
                    <option value="" disabled ${!tipoPreseleccionado ? 'selected' : ''}>Tipo...</option>
                    ${optionsHtml}
                </select>
            </div>
            <div class="col-7 contenedor-valor">
                <input type="text" class="form-control form-control-sm" disabled placeholder="Seleccione un tipo primero">
            </div>
            <input type="hidden" name="criteriosPertenenciaValores" class="input-valor-final" value="${valorPreseleccionado || ''}">

            <div class="col-1 text-end">
                <button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('.criterio-row').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
            container.appendChild(row);

            // Si venía preseleccionado, forzamos la renderización del input correcto
            if (tipoPreseleccionado) {
                const select = row.querySelector('.selector-tipo');
                cambiarInputValor(select, valorPreseleccionado);
            }
        }

        function cambiarInputValor(selectElement, valorInicial = null) {
            const tipo = selectElement.value;
            const row = selectElement.closest('.criterio-row');
            const container = row.querySelector('.contenedor-valor');
            const inputHidden = row.querySelector('.input-valor-final');

            // Si no es carga inicial, limpiamos el hidden
            if (!valorInicial) inputHidden.value = "";

            let htmlInput = '';

            if (tipo === 'TITULO') {
                htmlInput = `<input type="text" class="form-control form-control-sm" placeholder="Ingrese texto..." value="${valorInicial || ''}" oninput="actualizarValor(this)">`;

            } else if (tipo === 'CATEGORIA') {
                let cats = '<option value="" disabled ' + (!valorInicial ? 'selected' : '') + '>Seleccione...</option>';
                listaCategorias.forEach(c => {
                    const sel = (valorInicial && c === valorInicial) ? 'selected' : '';
                    cats += `<option value="${c}" ${sel}>${c}</option>`;
                });
                htmlInput = `<select class="form-select form-select-sm" onchange="actualizarValor(this)">${cats}</select>`;

            } else if (tipo === 'UBICACION') {
                let provs = '<option value="" disabled ' + (!valorInicial ? 'selected' : '') + '>Seleccione Provincia...</option>';
                listaProvincias.forEach(p => {
                    const sel = (valorInicial && p === valorInicial) ? 'selected' : '';
                    provs += `<option value="${p}" ${sel}>${p}</option>`;
                });
                htmlInput = `<select class="form-select form-select-sm" onchange="actualizarValor(this)">${provs}</select>`;

            } else if (tipo === 'FECHA') {
                // Si hay valor inicial (YYYY-MM-DDT...|YYYY-MM-DDT...), lo separamos
                let valInicio = '';
                let valFin = '';
                if (valorInicial && valorInicial.includes('|')) {
                    const partes = valorInicial.split('|');
                    valInicio = partes[0].split('T')[0]; // Nos quedamos solo con la fecha YYYY-MM-DD
                    valFin = partes[1].split('T')[0];
                }

                htmlInput = `
                    <div class="input-group input-group-sm">
                        <input type="date" class="form-control" id="f-inicio" value="${valInicio}" onchange="actualizarFecha(this)">
                        <span class="input-group-text">a</span>
                        <input type="date" class="form-control" id="f-fin" value="${valFin}" onchange="actualizarFecha(this)">
                    </div>`;
            }

            container.innerHTML = htmlInput;
        }

        // Función genérica para actualizar el input hidden (Selects y Texto)
        window.actualizarValor = function(el) {
            const row = el.closest('.criterio-row');
            const inputHidden = row.querySelector('.input-valor-final');

            // Reemplazar comas por espacios - evita que Spring rompa la lista en el backend
            let valorLimpio = el.value.replace(/,/g, ' ');

            inputHidden.value = valorLimpio;
        }

        // Función específica para concatenar fechas
        window.actualizarFecha = function(el) {
            const row = el.closest('.criterio-row');
            const inicio = row.querySelector('#f-inicio').value;
            const fin = row.querySelector('#f-fin').value;
            const inputHidden = row.querySelector('.input-valor-final');

            if (inicio && fin) {
                // Formato que espera tu Backend: "YYYY-MM-DDTHH:mm|YYYY-MM-DDTHH:mm"
                // Agregamos horas para cubrir todo el día
                inputHidden.value = `${inicio}T00:00:00|${fin}T23:59:59`;
            } else {
                inputHidden.value = ""; // Incompleto
            }
            
            // --- VALIDACIÓN AL ENVIAR EL FORMULARIO ---
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const filas = document.querySelectorAll('.criterio-row');
                    filas.forEach(fila => {
                        const selectTipo = fila.querySelector('select[name="criteriosPertenenciaNombres"]');
                        const inputValor = fila.querySelector('input[name="criteriosPertenenciaValores"]');
                        if (!selectTipo.value || !inputValor.value || inputValor.value.trim() === '') {
                            fila.remove();
                        }
                    });
                });
            }
        }
    </script>
</div>

</body>
</html>