<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle=~{::title}, content=~{::#main-content}, pageScripts=~{::#page-scripts})}">

<head>
    <title>MetaMapa - Hechos de la Colección</title>
</head>
<body>

<main class="container-fluid" id="main-content"></main>

<div id="page-scripts">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('collections');

            const params = new URLSearchParams(window.location.search);
            const collectionId = parseInt(params.get('collection_id'));
            const collection = collections.find(c => c.handle_id === collectionId);

            if (collection) {
                let pageState = {
                    collectionId: collectionId,
                    collection: collection,
                    mapView: false,
                    viewMode: 'irrestricto',
                    searchTerm: '',
                    filters: { date: '', category: '', source: '' }
                };

                const reRenderResults = () => renderFactsResults(pageState);

                mainContent.addEventListener('change', (e) => {
                    if (e.target.name === 'viewMode') pageState.viewMode = e.target.id;
                    if (['filter-date', 'filter-category', 'filter-source'].includes(e.target.id)) {
                        pageState.filters[e.target.id.replace('filter-', '')] = e.target.value;
                    }
                    reRenderResults();
                });

                mainContent.addEventListener('input', (e) => {
                    if (e.target.id === 'search-input') {
                        pageState.searchTerm = e.target.value;
                        reRenderResults();
                    }
                });

                mainContent.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    if (button.id === 'map-view-btn') pageState.mapView = true;
                    if (button.id === 'list-view-btn') pageState.mapView = false;

                    if (button.dataset.deleteFactId) {
                        const factId = parseInt(button.dataset.deleteFactId);
                        openModal(renderFactDeletionModal, factId);
                    }

                    if (['map-view-btn', 'list-view-btn'].includes(button.id)) {
                        renderFactsPageLayout(pageState);
                        reRenderResults();
                    }
                });

                renderFactsPageLayout(pageState);
                reRenderResults();
            } else {
                mainContent.innerHTML = `<div class="p-5 text-center"><h2 class="text-danger">Error: Colección no encontrada</h2><p>La colección que buscas no existe.</p><a href="/" class="btn btn-primary">Volver al inicio</a></div>`;
            }
        });
    </script>
</div>

</body>
</html>