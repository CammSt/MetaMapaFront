<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle='Administración', content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
    <body>
        <main id="main-content">
            <div class="container-fluid p-4 animate__animated animate__fadeIn" >
                <div class="card shadow-lg border-0 rounded-3">
                    <div class="card-header bg-primary text-white border-bottom-0 p-4 rounded-top-3"><h3 class="fw-bold mb-0">Panel de Administración</h3></div>
                    <div class="card-body p-4">

                        <div id="alert-placeholder">
                            <div th:if="${success}" class="alert alert-success d-flex align-items-center" role="alert">
                                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                                <span th:text="${success}"></span>
                            </div>
                            <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                <span th:text="${error}"></span>
                            </div>
                        </div>

                        <ul class="nav nav-pills nav-justified mb-4">
                            <li class="nav-item"><button id="admin-tab-collections" class="nav-link active">Gestionar Colecciones</button></li>
                            <li class="nav-item"><button id="admin-tab-requests" class="nav-link">Revisar Solicitudes</button></li>
                        </ul>

                        <div id="admin-tab-content-wrapper">

                            <div id="collections-content">
                                <div class="d-flex gap-2 mb-4">
                                    <a th:href="@{/admin/colecciones/nueva}" class="btn btn-success rounded-pill px-4 fw-bold">+ Nueva Colección</a>
                                    <button type="button" class="btn btn-info rounded-pill px-4 fw-bold text-white" data-bs-toggle="modal" data-bs-target="#csvImportModal">
                                        <i class="bi bi-upload me-2"></i>Importar CSV
                                    </button>
                                    <a th:href="@{/admin/estadisticas}" class="btn btn-warning rounded-pill px-4 fw-bold text-dark"><i class="bi bi-graph-up me-2"></i> Ver Estadísticas</a>
                                </div>

                                <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                                    <div th:if="${#lists.isEmpty(colecciones)}" class="text-center text-muted p-5">No hay colecciones para gestionar.</div>
                                    <table th:unless="${#lists.isEmpty(colecciones)}" class="table table-striped table-hover mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th class="text-secondary fw-bold">Título</th>
                                            <th class="text-secondary fw-bold">Fuente</th>
                                            <th class="text-end text-secondary fw-bold">Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="col : ${colecciones}">
                                            <td th:text="${col.titulo}"></td>
                                            <td><span class="badge bg-secondary">Carga Manual</span></td>
                                            <td class="text-end">
                                                <a th:href="@{/admin/colecciones/{id}/editar-completo(id=${col.handleID})}" class="btn btn-primary btn-sm rounded-pill">Editar Colección</a>
                                                <form th:action="@{/admin/colecciones/{id}/eliminar(id=${col.handleID})}" method="post" class="d-inline" onsubmit="return confirm('¿Estás seguro?');">
                                                    <button type="submit" class="btn btn-danger btn-sm rounded-pill">Eliminar</button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="requests-content" style="display: none;">
                                <div class="card card-body mb-3 bg-light border-0">
                                    <div class="row g-3 align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label small">Filtrar por tipo</label>
                                            <select class="form-select form-select-sm" id="admin-filter-type">
                                                <option value="">Todos</option>
                                                <option value="Nuevo Hecho">Nuevo Hecho</option>
                                                <option value="Eliminación">Eliminación</option>
                                                <option value="Edición">Edición</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Filtrar por estado</label>
                                            <select class="form-select form-select-sm" id="admin-filter-status">
                                                <option value="">Todos</option>
                                                <option value="PENDIENTE">Pendiente</option>
                                                <option value="APROBADA">Aprobada</option>
                                                <option value="RECHAZADA">Rechazada</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th class="text-secondary fw-bold">Título</th>
                                            <th class="text-secondary fw-bold">Tipo</th>
                                            <th class="text-secondary fw-bold">Estado</th>
                                            <th class="text-end text-secondary fw-bold">Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody id="admin-requests-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="evaluationModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title fw-bold" id="modalTitle">Evaluación</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div id="modalContent">Cargando...</div>
                                <!-- Textarea para sugerencia -->
                                <div id="sugerencia-container" class="mt-3" style="display:none;">
                                    <label for="inputSugerencia" class="form-label fw-bold">Sugerencia del admin</label>
                                    <textarea id="inputSugerencia" class="form-control" maxlength="1000" rows="3" placeholder="Escriba la sugerencia..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>

                                <form id="formReject" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger rounded-pill fw-bold px-4">
                                        <i class="bi bi-x-circle me-2"></i>Rechazar
                                    </button>
                                </form>

                                <form id="formApprove" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-success rounded-pill fw-bold px-4">
                                        <i class="bi bi-check-circle me-2"></i>Aprobar
                                    </button>
                                </form>

                                <form id="formApproveWithSuggestion" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-warning rounded-pill fw-bold px-4">
                                        <i class="bi bi-lightbulb me-2"></i>Aceptar con Sugerencia
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div id="page-scripts">
            <script th:inline="javascript">
                /*<![CDATA[*/
                const allCollections = /*[[${colecciones}]]*/ [];
                const allRequests = /*[[${solicitudes}]]*/ [];
                /*]]>*/
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    renderSidebar('admin');

                    const modal = document.getElementById('evaluationModal');
                    document.body.appendChild(modal); // mueve el modal al body en runtime

                    // --- TABS ---
                    const tabCollections = document.getElementById('admin-tab-collections');
                    const tabRequests = document.getElementById('admin-tab-requests');
                    const contentCollections = document.getElementById('collections-content');
                    const contentRequests = document.getElementById('requests-content');

                    tabCollections.addEventListener('click', () => {
                        tabCollections.classList.add('active'); tabRequests.classList.remove('active');
                        contentCollections.style.display = 'block'; contentRequests.style.display = 'none';
                    });
                    tabRequests.addEventListener('click', () => {
                        tabRequests.classList.add('active'); tabCollections.classList.remove('active');
                        contentRequests.style.display = 'block'; contentCollections.style.display = 'none';
                    });

                    // --- TABLA Y FILTROS ---
                    const tableBody = document.getElementById('admin-requests-table-body');
                    const filterType = document.getElementById('admin-filter-type');
                    const filterStatus = document.getElementById('admin-filter-status');

                    function renderTable(requests) {
                        tableBody.innerHTML = '';
                        if (!requests || requests.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-3">No hay solicitudes pendientes.</td></tr>';
                            return;
                        }

                        console.log("requests to render:", requests);

                        requests.forEach(req => {
                            let badgeClass = req.estado === 'PENDIENTE' ? 'bg-warning' : (req.estado === 'APROBADA' ? 'bg-success' : 'bg-danger');
                            let actionBtn = '-';

                            if (req.estado === 'PENDIENTE') {
                                actionBtn = `<button class="btn btn-primary btn-sm rounded-pill btn-view-detail"
                                data-id="${req.id}"
                                data-type="${req.tipo}"
                                data-title="${req.tituloDelHechoAEliminar}">
                                <i class="bi bi-eye me-1"></i> Ver Detalle
                             </button>`;
                            }

                            tableBody.innerHTML += `
                                <tr>
                                    <td class="fw-bold">${req.tituloDelHechoAEliminar || 'Sin título'}</td>
                                    <td><span class="badge bg-info text-dark">${req.tipo}</span></td>
                                    <td><span class="badge ${badgeClass}">${req.estado}</span></td>
                                    <td class="text-end">${actionBtn}</td>
                                </tr>`;
                        });
                    }

                    function applyFilters() {
                        const type = filterType.value;
                        const status = filterStatus.value;

                        const filtered = allRequests.filter(req => {
                            let estadoMatch = true;

                            if (status) {
                                if (status === "APROBADA") {
                                    // si seleccionaste APROBADA, incluimos también las creaciones ACEPTADAS
                                    estadoMatch = req.estado === "APROBADA" || req.estado === "ACEPTADO";
                                } else if (status === "RECHAZADA") {
                                    // incluir ambos tipos de rechazo si existen
                                    estadoMatch = req.estado === "RECHAZADA" || req.estado === "RECHAZADO";
                                } else {
                                    estadoMatch = req.estado === status;
                                }
                            }

                            const typeMatch = !type || req.tipo === type;
                            return estadoMatch && typeMatch;
                        });

                        renderTable(filtered);
                    }

                    filterType.addEventListener('change', applyFilters);
                    filterStatus.addEventListener('change', applyFilters);
                    renderTable(allRequests);

                    // --- LOGICA DEL MODAL ---
                    document.addEventListener('click', function(e) {
                        const btn = e.target.closest('.btn-view-detail');
                        if (btn) {
                            const id = btn.getAttribute('data-id');
                            const tipo = btn.getAttribute('data-type');
                            const titulo = btn.getAttribute('data-title');

                            // Validar ID antes de llamar
                            if (!id || id === 'null') {
                                alert("Error: Esta solicitud tiene un ID inválido y no se puede procesar.");
                                return;
                            }

                            const modalTitle = document.getElementById('modalTitle');
                            const modalContent = document.getElementById('modalContent');
                            const sugerenciaContainer = document.getElementById('sugerencia-container');

                            const inputSugerencia = document.getElementById('inputSugerencia');
                            const sugerencia = inputSugerencia.value.trim();
                            console.log("Sugerencia actual al abrir modal:", sugerencia);

                            // const formApprove = document.getElementById('formApprove');
                            const formApproveWithSuggestion = document.getElementById('formApproveWithSuggestion');
                            const formReject = document.getElementById('formReject');

                            modalTitle.textContent = `Evaluando: ${tipo}`;
                            modalContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando detalles...</p></div>';

                            sugerenciaContainer.style.display = 'none';
                            inputSugerencia.value = '';

                            // Configurar Actions TODO: REVISAR RUTAS
                            if (tipo === 'Nuevo Hecho') {
                                formApprove.action = `/hechos/${id}/aprobar`;
                                formReject.action = `/hechos/${id}/rechazar`;
                                formApproveWithSuggestion.action = `http://localhost:8082/dinamica/hechos/${id}/aceptar-con-sugerencia`;

                                sugerenciaContainer.style.display = 'block';
                                inputSugerencia.value = '';

                            } else if (tipo === 'Eliminación') {
                                formApprove.action = `/solicitudes/${id}/aprobar`;
                                formReject.action = `/solicitudes/${id}/rechazar`;
                            } else if (tipo === 'Edición') {
                                formApprove.action = `/ediciones/${id}/aceptar`;
                                formReject.action = `/ediciones/${id}/rechazar`;
                            }

                            // Mostrar Modal
                            const modal = new bootstrap.Modal(document.getElementById('evaluationModal'));
                            modal.show();

                            // Llamada AJAX SEGÚN TIPO
                            let apiURL = null;

                            if (tipo === "Nuevo Hecho") {
                                apiURL = `http://localhost:8082/dinamica/hechos/${id}`;
                            } else if (tipo === "Edición") {
                                apiURL = `http://localhost:8082/dinamica/ediciones/${id}`;
                            } else if (tipo === "Eliminación") {
                                apiURL = `http://localhost:8081/agregador/solicitudes/${id}/detalle?tipo=Eliminación`; // Revisa si esta URL es correcta
                            }


                            fetch(apiURL, {
                                headers: {
                                    'Authorization': 'Bearer ' + sessionStorage.getItem('accessToken')
                                }
                            })
                                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                                .then(({ status, body }) => {

                                    if (status >= 400) throw new Error(body.error || "Error desconocido");

                                    let html = "";
                                    const data = body.datos || body;

                                    /* -------------------------------------------
                                     * TIPO: NUEVO HECHO
                                     * ------------------------------------------- */
                                    if (tipo === "Nuevo Hecho") {
                                        const fecha = data.fechaAcontecimiento
                                            ? new Date(data.fechaAcontecimiento).toLocaleString()
                                            : '-';

                                        html = `
                                            <div class="alert alert-info border-0 shadow-sm mb-3">
                                                <i class="bi bi-info-circle me-2"></i>Propuesta de creación
                                            </div>
                                            <h4 class="text-primary fw-bold mb-3">${data.titulo || 'Sin título'}</h4>
                                            <p class="lead fs-6">${data.descripcion || 'Sin descripción'}</p>

                                            <div class="row g-2 small text-muted mb-3">
                                                <div class="col-6"><strong>Categoría:</strong> <span class="badge bg-secondary">${data.categoria}</span></div>
                                                <div class="col-6"><strong>Fecha:</strong> ${fecha}</div>
                                            </div>

                                            <div class="card border-0">
                                                <div class="card-header bg-white fw-bold small text-muted">Ubicación Geográfica</div>
                                                <div class="card-body p-0">
                                                    <div id="modal-map-container" style="height: 250px; width: 100%; background: #eee; border-radius: 0 0 8px 8px;"></div>
                                                </div>
                                            </div>
                                        `;
                                    }

                                    /* -------------------------------------------
                                     * TIPO: ELIMINACIÓN
                                     * ------------------------------------------- */
                                    else if (tipo === "Eliminación") {
                                        html = `
                                            <div class="alert alert-danger border-0 shadow-sm mb-3">
                                                <i class="bi bi-trash3 me-2"></i>Solicitud de Baja
                                            </div>
                                            <p>Se solicita eliminar: <strong>${data.tituloDelHechoAEliminar}</strong></p>
                                            <div class="card border-danger">
                                                <div class="card-body text-danger p-3">
                                                    <strong>Motivo del solicitante:</strong><br>${data.motivo}
                                                </div>
                                            </div>`;
                                    }
                                    /* -------------------------------------------
                                     * TIPO: EDICIÓN
                                     * ------------------------------------------- */
                                    else if (tipo === "Edición") {
                                        const d = data; // datos directos
                                        const orig = data.hechoOriginal || {};

                                        html = `
                                            <div class="alert alert-warning border-0 shadow-sm mb-3">
                                                <i class="bi bi-pencil me-2"></i>Propuesta de Edición
                                            </div>
                                            <div class="row g-0 border rounded">
                                                <div class="col-6 border-end bg-light p-3">
                                                    <h6 class="text-center text-muted small fw-bold text-uppercase">Original</h6>
                                                    <div class="mb-2"><small class="fw-bold">Título:</small><div>${orig.titulo || '-'}</div></div>
                                                    <div class="mb-2"><small class="fw-bold">Descripción:</small><div>${orig.descripcion || '-'}</div></div>
                                                    <div class="mb-2"><small class="fw-bold">Categoría:</small><div>${orig.categoriaNombre || '-'}</div></div>
                                                </div>
                                                <div class="col-6 bg-white p-3">
                                                    <h6 class="text-center text-primary small fw-bold text-uppercase">Propuesta</h6>
                                                    <div class="mb-2"><small class="fw-bold">Título:</small><div>${d.tituloPropuesto || '-'}</div></div>
                                                    <div class="mb-2"><small class="fw-bold">Descripción:</small><div>${d.descripcionPropuesta || '-'}</div></div>
                                                    <div class="mb-2"><small class="fw-bold">Categoría:</small><div>${d.categoriaPropuestaNombre || '-'}</div></div>
                                                </div>
                                            </div>
                                        `;
                                    }

                                    modalContent.innerHTML = html;

                                    // Render mapa SOLO si es nuevo hecho
                                    if (tipo === "Nuevo Hecho") {
                                        setTimeout(() => {
                                            if (data.latitud && data.longitud) {
                                                const map = L.map('modal-map-container').setView([data.latitud, data.longitud], 15);

                                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                    attribution: '© OpenStreetMap contributors'
                                                }).addTo(map);

                                                L.marker([data.latitud, data.longitud]).addTo(map)
                                                    .bindPopup(`<b>${data.titulo}</b>`).openPopup();

                                                map.invalidateSize();
                                            }
                                        }, 300);
                                    }
                                })
                                .catch(err => {
                                    console.error(err);
                                    modalContent.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
                                });

                                console.log(JSON.stringify({ sugerencia }))
                                // Submit Aceptar con Sugerencia
                                formApproveWithSuggestion.addEventListener('submit', function(e) {
                                    e.preventDefault();
                                    const sugerencia = inputSugerencia.value.trim();
                                    if (!sugerencia) {
                                        alert('Debes escribir una sugerencia antes de enviar.');
                                        return;
                                    }

                                    fetch(formApproveWithSuggestion.action, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': 'Bearer ' + sessionStorage.getItem('accessToken')
                                        },
                                        body: JSON.stringify({ sugerencia })
                                    })
                                        .then(res => res.json())
                                        .then(res => {
                                            alert(res.mensaje || 'Hecho aceptado con sugerencia');
                                            location.reload();
                                        })
                                        .catch(err => console.error(err));
                                });
                        }
                    });
                });
            </script>
        </div>
    </body>
</html>