<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle='Administración', content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>
<main class="container-fluid p-4 animate__animated animate__fadeIn" id="main-content">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white border-bottom-0 p-4 rounded-top-3"><h3 class="fw-bold mb-0">Panel de Administración</h3></div>
        <div class="card-body p-4">

            <div id="alert-placeholder">
                <div th:if="${success}" class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                    <span th:if="${success.contains('procesando')}">El archivo CSV se subió correctamente!</span>
                    <span th:unless="${success.contains('procesando')}" th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <span th:if="${error.contains('CSV')}">Hubo un error al procesar el archivo. Por favor, revísalo e inténtalo de nuevo. Recordá que solo se admiten archivos .CSV</span>
                    <span th:unless="${error.contains('CSV')}" th:text="${error}"></span>
                </div>
            </div>
            <ul class="nav nav-pills nav-justified mb-4">
                <li class="nav-item"><button id="admin-tab-collections" class="nav-link active">Gestionar Colecciones</button></li>
                <li class="nav-item"><button id="admin-tab-requests" class="nav-link">Revisar Solicitudes</button></li>
            </ul>

            <div id="admin-tab-content-wrapper">
                <div id="collections-content">
                    <div class="d-flex gap-2 mb-4">
                        <a th:href="@{/admin/colecciones/nueva}" class="btn btn-success rounded-pill px-4 fw-bold">
                            + Nueva Colección
                        </a>
                        <button type="button" class="btn btn-info rounded-pill px-4 fw-bold text-white"
                                data-bs-toggle="modal" data-bs-target="#csvImportModal">
                            <i class="bi bi-upload me-2"></i>Importar CSV
                        </button>
                        <a th:href="@{/admin/estadisticas}" class="btn btn-warning rounded-pill px-4 fw-bold text-dark">
                            <i class="bi bi-graph-up me-2"></i> Ver Estadísticas
                        </a>
                    </div>
                    <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                        <div th:if="${#lists.isEmpty(colecciones)}" class="text-center text-muted p-5">No hay colecciones para gestionar.</div>
                        <table th:unless="${#lists.isEmpty(colecciones)}" class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="text-secondary fw-bold">Título</th>
                                <th class="text-secondary fw-bold">Fuente</th>
                                <th class="text-end text-secondary fw-bold">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="col : ${colecciones}">
                                <td th:text="${col.titulo()}"></td>
                                <td><span class="badge bg-secondary">Carga Manual</span></td>
                                <td class="text-end">

                                    <a th:href="@{/admin/colecciones/{id}/editar(id=${col.handleID()})}" class="btn btn-primary btn-sm rounded-pill">
                                        Editar
                                    </a>

                                    <form th:action="@{/admin/colecciones/{id}/eliminar(id=${col.handleID()})}" method="post" class="d-inline"
                                          onsubmit="return confirm('¿Estás seguro de que deseas eliminar esta colección?');">
                                        <button type="submit" class="btn btn-danger btn-sm rounded-pill">
                                            Eliminar
                                        </button>
                                    </form>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="requests-content" style="display: none;">
                    <div class="card card-body mb-3 bg-light border-0">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <label class="form-label small">Filtrar por tipo</label>
                                <select class="form-select form-select-sm" id="admin-filter-type">
                                    <option value="">Todos</option>
                                    <option value="Nuevo Hecho">Nuevo Hecho</option>
                                    <option value="Eliminación">Eliminación</option>
                                    <option value="Edición">Edición</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Filtrar por estado</label>
                                <select class="form-select form-select-sm" id="admin-filter-status">
                                    <option value="">Todos</option>
                                    <option value="PENDIENTE">Pendiente</option>
                                    <option value="APROBADA">Aprobada</option>
                                    <option value="RECHAZADA">Rechazada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                        <div th:if="${#lists.isEmpty(solicitudes)}" class="text-center text-muted p-5">No hay solicitudes pendientes.</div>
                        <table th:unless="${#lists.isEmpty(solicitudes)}" class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="text-secondary fw-bold">Título</th>
                                <th class="text-secondary fw-bold">Tipo</th>
                                <th class="text-secondary fw-bold">Estado</th>
                                <th class="text-end text-secondary fw-bold">Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="admin-requests-table-body">
                            <tr th:each="req : ${solicitudes}">
                                <td th:text="${req.tituloDelHechoAEliminar}"></td>
                                <td><span class="badge bg-info" th:text="${req.tipo}"></span></td>
                                <td><span class="badge" th:classappend="${req.estado == 'PENDIENTE' ? 'bg-warning' : (req.estado == 'APROBADA' || req.estado == 'ACEPTADO' || req.estado == 'ACEPTADO_CON_SUGERENCIAS' ? 'bg-success' : 'bg-danger')}" th:text="${req.estado}"></span></td>
                                <td class="text-end">
                                    <div th:if="${req.estado == 'PENDIENTE'}">
                                        <button th:attr="data-request-id=${req.id}, data-request-type=${req.tipo}, data-is-pending='true'"
                                                class="btn btn-warning btn-sm rounded-pill btn-review-modal">
                                            Evaluar
                                        </button>
                                    </div>
                                    <div th:unless="${req.estado == 'PENDIENTE'}">
                                        <button th:attr="data-request-id=${req.id}, data-request-type=${req.tipo}, data-request-estado=${req.estado}, data-is-pending='false'"
                                                class="btn btn-sm btn-outline-info rounded-pill btn-review-modal">
                                            Ver Resolución
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

    <div class="modal fade" id="adminResolutionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="resolutionModalTitle">Evaluar Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="admin-resolution-form" method="post">
                    <div class="modal-body">
                        <p id="resolution-request-details" class="text-muted small mb-3">Cargando detalles...</p>

                        <div id="view-resolution-block" style="display:none;">
                            <p class="mb-2"><strong>Estado Final:</strong> <span id="view-status-badge" class="badge"></span></p>
                            <p class="mb-0"><strong>Comentario:</strong> <span id="view-detalle-text" class="text-muted"></span></p>
                        </div>

                        <div id="evaluation-block" style="display:none;">
                            <div class="mb-3" id="status-selector-block">
                                <label for="resolution-status" class="form-label fw-bold">Decisión</label>
                                <select id="resolution-status" name="estado" class="form-select" required>
                                </select>
                            </div>

                            <div class="mb-3" id="detalle-container" style="display:none;">
                                <label for="detalle" class="form-label fw-bold text-danger">Detalle/Comentario</label>
                                <textarea id="detalle" name="detalle" class="form-control" rows="4" placeholder="Detalle la razón del rechazo o las sugerencias de edición."></textarea>
                            </div>
                        </div>

                        <input type="hidden" name="id" id="resolution-request-id-input">
                    </div>
                    <div class="modal-footer" id="resolution-modal-footer">
                        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4" id="submit-resolver-btn">Resolver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

<div id="page-scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const allCollections = /*[[${colecciones}]]*/ [];
        const consensusLabels = /*[[${consensusLabels}]]*/ {};
        const availableSources = /*[[${availableSources}]]*/ {};
        const allRequestsForFilter = /*[[${solicitudes}]]*/ [];
        /*]]>*/
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('admin');

            // --- LÓGICA DE TABS ---
            const tabCollections = document.getElementById('admin-tab-collections');
            const tabRequests = document.getElementById('admin-tab-requests');
            const contentCollections = document.getElementById('collections-content');
            const contentRequests = document.getElementById('requests-content');

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tab') === 'requests') {
                tabCollections.classList.remove('active');
                tabRequests.classList.add('active');
                contentCollections.style.display = 'none';
                contentRequests.style.display = 'block';
            }

            tabCollections.addEventListener('click', () => {
                tabCollections.classList.add('active');
                tabRequests.classList.remove('active');
                contentCollections.style.display = 'block';
                contentRequests.style.display = 'none';
            });

            tabRequests.addEventListener('click', () => {
                tabRequests.classList.add('active');
                tabCollections.classList.remove('active');
                contentRequests.style.display = 'block';
                contentCollections.style.display = 'none';
            });


            // --- LÓGICA DE EVALUACIÓN Y MODAL ADMIN (Resolución y Detalle) ---
            const resolutionModalEl = document.getElementById('adminResolutionModal');
            const resolutionForm = document.getElementById('admin-resolution-form');
            const statusSelect = document.getElementById('resolution-status');
            const detalleContainer = document.getElementById('detalle-container');
            const detalleInput = document.getElementById('detalle');
            const evaluationBlock = document.getElementById('evaluation-block');
            const viewResolutionBlock = document.getElementById('view-resolution-block');
            const modalTitle = resolutionModalEl.querySelector('#resolutionModalTitle');
            const detailContainerInModal = resolutionModalEl.querySelector('#resolution-request-details');

            let resolutionModal = new bootstrap.Modal(resolutionModalEl);

            // Lógica para mostrar/ocultar el detalle/motivo del modal de resolución
            statusSelect.addEventListener('change', function() {
                const value = this.value;
                const requestType = resolutionModalEl.getAttribute('data-current-type');

                const isNewHecho = requestType === 'Nuevo Hecho';
                const isRechazoOSugerencia = value === 'RECHAZADO' || value === 'ACEPTADO_CON_SUGERENCIAS' || value.includes('rechazar');

                const requiresDetail = isNewHecho && isRechazoOSugerencia;
                const isVisible = isRechazoOSugerencia;

                if (isVisible) {
                    detalleContainer.style.display = 'block';
                    detalleInput.required = requiresDetail;
                    detalleContainer.querySelector('label').textContent = requiresDetail
                        ? 'Detalle/Comentario (Obligatorio)'
                        : 'Detalle/Comentario (Opcional)';
                } else {
                    detalleContainer.style.display = 'none';
                    detalleInput.required = false;
                }
            });

            // --- Función para obtener detalles completos vía AJAX (Necesaria para "Ver Solicitud") ---
            function fetchFullDetail(id, type) {
                let apiUrl = '';
                if (type === 'Nuevo Hecho') {
                    apiUrl = `/admin/api/hechos/${id}`;
                } else if (type === 'Edición') {
                    apiUrl = `/admin/api/ediciones/${id}`;
                } else if (type === 'Eliminación') {
                    apiUrl = `/admin/api/solicitudes-eliminacion/${id}`;
                } else {
                    throw new Error('Tipo de solicitud desconocido.');
                }

                return fetch(apiUrl).then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || response.statusText); });
                    }
                    return response.json();
                });
            }


            // Listener Principal para los botones de la tabla
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.btn-evaluate, .btn-view-solicitud');
                if (!btn) return;

                const requestId = btn.getAttribute('data-request-id');
                const requestType = btn.getAttribute('data-request-type');
                const isEvaluate = btn.classList.contains('btn-evaluate');

                const requestDataUnificada = allRequestsForFilter.find(r => r.id == requestId && r.tipo === requestType);

                if (!requestDataUnificada) {
                    alert("No se encontró el detalle de la solicitud/edición.");
                    return;
                }

                // 1. Configurar carga inicial (siempre necesario para 'Ver Solicitud' y 'Evaluar')
                // FIX: El botón "Ver Solicitud" ya no usa el modal de resolución, sino el modal genérico (openModal)

                // --- ACCIÓN 1: VER SOLICITUD (Muestra todos los detalles en el modal genérico) ---
                if (!isEvaluate) {
                    // Mostrar indicador de carga en el contenedor temporal
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Cargando detalles completos...</p></div>';
                    // Usamos openModal con un DTO básico de carga. El modal robusto lo reemplazará.
                    openModal(renderRequestDetailModal, requestDataUnificada);

                    fetchFullDetail(requestId, requestType)
                        .then(fullDetailDTO => {
                            const fullData = Object.assign({}, requestDataUnificada, fullDetailDTO);
                            // Abre el modal de detalle completo (renderRequestDetailModal debe estar en main.js)
                            openModal(renderRequestDetailModal, fullData);
                        })
                        .catch(error => {
                            alert('Error al cargar los detalles: ' + error.message);
                            console.error('Fetch Error:', error);
                            openModal(renderRequestDetailModal, {
                                tipo: requestType, estado: requestDataUnificada.estado,
                                tituloDelHechoAEliminar: `Error al cargar: ${error.message}`
                            });
                        });

                    return;
                }


                // --- ACCIÓN 2: EVALUAR (Solo PENDIENTE - Abre el modal de resolución simple) ---

                const hechoTitle = requestDataUnificada.tituloDelHechoAEliminar || 'Sin título';

                // 1. Configurar Modal para Resolución
                evaluationBlock.style.display = 'block';
                viewResolutionBlock.style.display = 'none';

                modalTitle.textContent = `Resolver Solicitud de ${requestType}`;
                resolutionModalEl.setAttribute('data-current-type', requestType);

                // 2. Mostrar mensaje simple (cumpliendo el requisito de no mostrar detalles complejos)
                detailContainerInModal.innerHTML = `<h6 class="text-primary fw-bold">Evaluando: ${requestType} - ${hechoTitle}</h6><p class="text-muted small">Revisa los detalles completos usando el botón "Ver Solicitud" antes de resolver.</p>`;

                // 3. Configurar Opciones y Form Action
                let optionsHtml = '<option value="">Seleccione el estado...</option>';

                if (requestType === 'Nuevo Hecho') {
                    optionsHtml += '<option value="ACEPTADO">Aprobar</option>';
                    optionsHtml += '<option value="RECHAZADO">Rechazar</option>';
                    optionsHtml += '<option value="ACEPTADO_CON_SUGERENCIAS">Aprobar con Sugerencias</option>';
                    resolutionForm.action = `/hechos/${requestId}/resolver`;
                } else if (requestType === 'Edición') {
                    optionsHtml += '<option value="aceptar">Aprobar Edición</option>';
                    optionsHtml += '<option value="rechazar">Rechazar Edición</option>';
                    resolutionForm.action = `/admin/ediciones/${requestId}`;
                } else if (requestType === 'Eliminación') {
                    optionsHtml += '<option value="aprobar">Aprobar Eliminación</option>';
                    optionsHtml += '<option value="rechazar">Rechazar Eliminación</option>';
                    resolutionForm.action = `/admin/solicitudes/${requestId}`;
                }

                statusSelect.innerHTML = optionsHtml;
                statusSelect.value = '';

                // 4. Lógica de Submit para manejar los endpoints separados del backend
                resolutionForm.onsubmit = function(event) {
                    event.preventDefault();
                    const selectedStatus = statusSelect.value;
                    let finalAction = resolutionForm.action;

                    if (!selectedStatus) {
                        alert("Por favor, selecciona un estado.");
                        return;
                    }

                    if (requestType === 'Nuevo Hecho') {
                        const hiddenStatusInput = document.createElement('input');
                        hiddenStatusInput.type = 'hidden';
                        hiddenStatusInput.name = 'estado';
                        hiddenStatusInput.value = selectedStatus;
                        resolutionForm.appendChild(hiddenStatusInput);
                    } else if (requestType === 'Edición' || requestType === 'Eliminación') {
                        finalAction += `/${selectedStatus}`;
                    }

                    resolutionForm.action = finalAction;
                    resolutionForm.onsubmit = null;
                    resolutionForm.submit();
                };

                // Abrir el modal de resolución (FIX para el pop-up)
                detalleInput.value = '';
                statusSelect.dispatchEvent(new Event('change'));
                resolutionModal.show();
            });


            // --- LÓGICA PARA FILTROS Y RENDERIZADO DE TABLA (FIX: Lógica de Filtrado Funcional) ---

            const adminFilterType = document.getElementById('admin-filter-type');
            const adminFilterStatus = document.getElementById('admin-filter-status');
            const requestsTableBody = document.getElementById('admin-requests-table-body');

            function renderAdminRequestsTable(requests) {
                requestsTableBody.innerHTML = '';
                if (requests.length === 0) {
                    requestsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">No hay solicitudes que coincidan con los filtros.</td></tr>';
                    return;
                }

                requests.forEach(req => {
                    const statusClass = req.estado === 'PENDIENTE'
                        ? 'bg-warning'
                        : (req.estado.includes('APROBA') || req.estado.includes('ACEPTA') ? 'bg-success' : 'bg-danger');

                    const isPending = req.estado === 'PENDIENTE';
                    const buttonClass = isPending ? 'btn-warning' : 'btn-outline-info';

                    const actionsHtml = `
                        <button data-request-id="${req.id}"
                                data-request-type="${req.tipo}"
                                data-request-estado="${req.estado}"
                                class="btn btn-sm btn-outline-info rounded-pill btn-view-solicitud me-2">
                            Ver Solicitud
                        </button>

                        ${isPending ?
                        `<button data-request-id="${req.id}"
                                     data-request-type="${req.tipo}"
                                     data-is-pending="true"
                                     class="btn ${buttonClass} btn-sm rounded-pill btn-evaluate">
                                Evaluar
                            </button>` : ''}
                    `;

                    requestsTableBody.innerHTML += `
                        <tr>
                            <td>${req.tituloDelHechoAEliminar}</td>
                            <td><span class="badge bg-info">${req.tipo}</span></td>
                            <td><span class="badge ${statusClass}">${req.estado}</span></td>
                            <td class="text-end">
                                <div>${actionsHtml}</div>
                            </td>
                        </tr>`;
                });
            }


            function applyAdminRequestFilters() {
                const typeValue = adminFilterType.value;
                const statusValue = adminFilterStatus.value;

                const normalizeStatus = (status) => {
                    if (status.includes('ACEPTAD') || status.includes('APROBADA')) return 'APROBADA';
                    if (status.includes('RECHAZAD')) return 'RECHAZADA';
                    return status;
                }

                const filteredRequests = allRequestsForFilter.filter(req => {
                    const typeMatch = !typeValue || req.tipo === typeValue;
                    const statusMatch = !statusValue || normalizeStatus(req.estado) === normalizeStatus(statusValue);

                    return typeMatch && statusMatch;
                });

                renderAdminRequestsTable(filteredRequests);
            }

            // FIX: Ejecutar la función de filtro cada vez que cambie un selector
            adminFilterType.addEventListener('change', applyAdminRequestFilters);
            adminFilterStatus.addEventListener('change', applyAdminRequestFilters);

            // Cargar la tabla al inicio
            applyAdminRequestFilters();

        });
    </script>
</div>
</body>
</html>