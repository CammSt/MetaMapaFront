<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle='Administración', content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>
<main class="container-fluid p-4 animate__animated animate__fadeIn" id="main-content">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white border-bottom-0 p-4 rounded-top-3"><h3 class="fw-bold mb-0">Panel de Administración</h3></div>
        <div class="card-body p-4">

            <div id="alert-placeholder">
                <div th:if="${success}" class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                    <span th:if="${success.contains('procesando')}">El archivo CSV se subió correctamente!</span>
                    <span th:unless="${success.contains('procesando')}" th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <span th:if="${error.contains('CSV')}">Hubo un error al procesar el archivo. Por favor, revísalo e inténtalo de nuevo. Recordá que solo se admiten archivos .CSV</span>
                    <span th:unless="${error.contains('CSV')}" th:text="${error}"></span>
                </div>
            </div>
            <ul class="nav nav-pills nav-justified mb-4">
                <li class="nav-item"><button id="admin-tab-collections" class="nav-link active">Gestionar Colecciones</button></li>
                <li class="nav-item"><button id="admin-tab-requests" class="nav-link">Revisar Solicitudes</button></li>
            </ul>

            <div id="admin-tab-content-wrapper">
                <div id="collections-content">
                    <div class="d-flex gap-2 mb-4">
                        <a th:href="@{/admin/colecciones/nueva}" class="btn btn-success rounded-pill px-4 fw-bold">
                            + Nueva Colección
                        </a>
                        <button type="button" class="btn btn-info rounded-pill px-4 fw-bold text-white"
                                data-bs-toggle="modal" data-bs-target="#csvImportModal">
                            <i class="bi bi-upload me-2"></i>Importar CSV
                        </button>
                        <a th:href="@{/admin/estadisticas}" class="btn btn-warning rounded-pill px-4 fw-bold text-dark">
                            <i class="bi bi-graph-up me-2"></i> Ver Estadísticas
                        </a>
                    </div>
                    <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                        <div th:if="${#lists.isEmpty(colecciones)}" class="text-center text-muted p-5">No hay colecciones para gestionar.</div>
                        <table th:unless="${#lists.isEmpty(colecciones)}" class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="text-secondary fw-bold">Título</th>
                                <th class="text-secondary fw-bold">Fuente</th>
                                <th class="text-end text-secondary fw-bold">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="col : ${colecciones}">
                                <td th:text="${col.titulo()}"></td>
                                <td><span class="badge bg-secondary">Carga Manual</span></td>
                                <td class="text-end">

                                    <a th:href="@{/admin/colecciones/{id}/editar(id=${col.handleID()})}" class="btn btn-primary btn-sm rounded-pill">
                                        Editar
                                    </a>

                                    <form th:action="@{/admin/colecciones/{id}/eliminar(id=${col.handleID()})}" method="post" class="d-inline"
                                          onsubmit="return confirm('¿Estás seguro de que deseas eliminar esta colección?');">
                                        <button type="submit" class="btn btn-danger btn-sm rounded-pill">
                                            Eliminar
                                        </button>
                                    </form>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="requests-content" style="display: none;">
                    <div class="card card-body mb-3 bg-light border-0">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <label class="form-label small">Filtrar por tipo</label>
                                <select class="form-select form-select-sm" id="admin-filter-type">
                                    <option value="">Todos</option>
                                    <option value="Nuevo Hecho">Nuevo Hecho</option>
                                    <option value="Eliminación">Eliminación</option>
                                    <option value="Edición">Edición</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Filtrar por estado</label>
                                <select class="form-select form-select-sm" id="admin-filter-status">
                                    <option value="">Todos</option>
                                    <option value="PENDIENTE">Pendiente</option>
                                    <option value="APROBADA">Aprobada</option>
                                    <option value="RECHAZADA">Rechazada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                        <div th:if="${#lists.isEmpty(solicitudes)}" class="text-center text-muted p-5">No hay solicitudes pendientes.</div>
                        <table th:unless="${#lists.isEmpty(solicitudes)}" class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="text-secondary fw-bold">Título</th>
                                <th class="text-secondary fw-bold">Tipo</th>
                                <th class="text-secondary fw-bold">Estado</th>
                                <th class="text-end text-secondary fw-bold">Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="admin-requests-table-body">
                            <tr th:each="req : ${solicitudes}">
                                <td th:text="${req.tituloDelHechoAEliminar}"></td>
                                <td><span class="badge bg-info" th:text="${req.tipo}"></span></td>
                                <td><span class="badge" th:classappend="${req.estado == 'PENDIENTE' ? 'bg-warning' : (req.estado == 'APROBADA' || req.estado == 'ACEPTADO' || req.estado == 'ACEPTADO_CON_SUGERENCIAS' ? 'bg-success' : 'bg-danger')}" th:text="${req.estado}"></span></td>
                                <td class="text-end">
                                    <div th:if="${req.estado == 'PENDIENTE'}">
                                        <button th:attr="data-request-id=${req.id}, data-request-type=${req.tipo}, data-is-pending='true'"
                                                class="btn btn-warning btn-sm rounded-pill btn-review-modal">
                                            Evaluar
                                        </button>
                                    </div>
                                    <div th:unless="${req.estado == 'PENDIENTE'}">
                                        <button th:attr="data-request-id=${req.id}, data-request-type=${req.tipo}, data-request-estado=${req.estado}, data-is-pending='false'"
                                                class="btn btn-sm btn-outline-info rounded-pill btn-review-modal">
                                            Ver Resolución
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

    <div class="modal fade" id="adminResolutionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="resolutionModalTitle">Evaluar Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="admin-resolution-form" method="post">
                    <div class="modal-body">
                        <p id="resolution-request-details" class="text-muted small mb-3">Cargando detalles...</p>

                        <div id="view-resolution-block" style="display:none;">
                            <p class="mb-2"><strong>Estado Final:</strong> <span id="view-status-badge" class="badge"></span></p>
                            <p class="mb-0"><strong>Comentario:</strong> <span id="view-detalle-text" class="text-muted"></span></p>
                        </div>

                        <div id="evaluation-block" style="display:none;">
                            <div class="mb-3" id="status-selector-block">
                                <label for="resolution-status" class="form-label fw-bold">Decisión</label>
                                <select id="resolution-status" name="estado" class="form-select" required>
                                </select>
                            </div>

                            <div class="mb-3" id="detalle-container" style="display:none;">
                                <label for="detalle" class="form-label fw-bold text-danger">Detalle/Comentario</label>
                                <textarea id="detalle" name="detalle" class="form-control" rows="4" placeholder="Detalle la razón del rechazo o las sugerencias de edición."></textarea>
                            </div>
                        </div>

                        <input type="hidden" name="id" id="resolution-request-id-input">
                    </div>
                    <div class="modal-footer" id="resolution-modal-footer">
                        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4" id="submit-resolver-btn">Resolver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

    <div id="page-scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            const allCollections = /*[[${colecciones}]]*/ [];
            const consensusLabels = /*[[${consensusLabels}]]*/ {};
            const availableSources = /*[[${availableSources}]]*/ [];
            const allRequestsForFilter = /*[[${solicitudes}]]*/ [];
            /*]]>*/
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                renderSidebar('admin');

                // --- LÓGICA DE TABS ---
                const tabCollections = document.getElementById('admin-tab-collections');
                const tabRequests = document.getElementById('admin-tab-requests');
                const contentCollections = document.getElementById('collections-content');
                const contentRequests = document.getElementById('requests-content');

                tabCollections.addEventListener('click', () => {
                    tabCollections.classList.add('active');
                    tabRequests.classList.remove('active');
                    contentCollections.style.display = 'block';
                    contentRequests.style.display = 'none';
                });

                tabRequests.addEventListener('click', () => {
                    tabRequests.classList.add('active');
                    tabCollections.classList.remove('active');
                    contentRequests.style.display = 'block';
                    contentCollections.style.display = 'none';
                });

                // Inicializar tabla al cargar
                // Se asume que la lógica de renderAdminRequestsTable ya está integrada en el servidor/código anterior.


                // --- LÓGICA DE EVALUACIÓN Y MODAL ADMIN (Goal 3 & 4) ---
                const resolutionModalEl = document.getElementById('adminResolutionModal');
                const resolutionForm = document.getElementById('admin-resolution-form');
                const statusSelect = document.getElementById('resolution-status');
                const detalleContainer = document.getElementById('detalle-container');
                const detalleInput = document.getElementById('detalle');
                const modalFooter = resolutionModalEl.querySelector('.modal-footer');
                const evaluationBlock = document.getElementById('evaluation-block');
                const viewResolutionBlock = document.getElementById('view-resolution-block');

                let resolutionModal = new bootstrap.Modal(resolutionModalEl); // Instanciar fuera del listener

                // Lógica para mostrar/ocultar el detalle/motivo
                statusSelect.addEventListener('change', function() {
                    const value = this.value;
                    // Usamos un atributo de datos para saber qué tipo de solicitud estamos evaluando
                    const requestType = resolutionModalEl.getAttribute('data-current-type');

                    // REGLA CLAVE: Detalle es obligatorio SÓLO para Nuevo Hecho (Rechazo o Sugerencias).
                    const isNewHecho = requestType === 'Nuevo Hecho';
                    const requiresDetail = isNewHecho && (value === 'RECHAZADO' || value === 'ACEPTADO_CON_SUGERENCIAS');

                    if (requiresDetail) {
                        detalleContainer.style.display = 'block';
                        detalleInput.required = true;
                        detalleContainer.querySelector('label').textContent = 'Detalle/Comentario (Obligatorio)';
                    } else {
                        detalleContainer.style.display = 'none';
                        detalleInput.required = false;
                        detalleContainer.querySelector('label').textContent = 'Detalle/Comentario'; // Resetear texto
                    }
                });


                // Listener para abrir el modal (Evaluar / Ver Resolución)
                document.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-review-modal');

                    if (btn) {
                        const requestId = btn.getAttribute('data-request-id');
                        const requestType = btn.getAttribute('data-request-type');
                        const isPending = btn.getAttribute('data-is-pending') === 'true';
                        const requestEstado = btn.getAttribute('data-request-estado');

                        const requestData = allRequestsForFilter.find(r => r.id == requestId && r.tipo === requestType);

                        if (!requestData) {
                            alert("No se encontró el detalle de la solicitud/edición.");
                            return;
                        }

                        // 1. Configurar Título y Type en el modal
                        resolutionModalEl.setAttribute('data-current-type', requestType);
                        resolutionModalEl.querySelector('#resolution-request-details').textContent = `Hecho: ${requestData.tituloDelHechoAEliminar}`;

                        // 2. Lógica de Modo (Evaluar vs. Ver Resolución)
                        if (isPending) {
                            // MODO EVALUAR
                            evaluationBlock.style.display = 'block';
                            viewResolutionBlock.style.display = 'none';
                            modalFooter.style.display = 'flex';

                            // Configurar Opciones del Selector
                            let optionsHtml = '<option value="">Seleccione el estado...</option>';
                            let formAction;

                            if (requestType === 'Nuevo Hecho') {
                                // 3 Estados: ACEPTADO, RECHAZADO, ACEPTADO_CON_SUGERENCIAS
                                optionsHtml += '<option value="ACEPTADO">Aceptar</option>';
                                optionsHtml += '<option value="RECHAZADO">Rechazar</option>';
                                optionsHtml += '<option value="ACEPTADO_CON_SUGERENCIAS">Aceptar con Sugerencias</option>';
                                formAction = `/admin/hechos/${requestId}/resolver`;
                            } else {
                                // Edición y Eliminación: Solo Aceptar/Rechazar (2 estados)
                                optionsHtml += '<option value="ACEPTADO">Aceptar</option>';
                                optionsHtml += '<option value="RECHAZADO">Rechazar</option>';
                                // La URL de acción se configura por convención
                                formAction = `/admin/${requestType.toLowerCase()}/${requestId}/resolver`;
                            }

                            statusSelect.innerHTML = optionsHtml;
                            statusSelect.value = '';

                            // Resetear Detalle (Obligatorio según el caso, ver listener change)
                            detalleContainer.style.display = 'none';
                            detalleInput.required = false;
                            resolutionForm.action = formAction;

                        } else {
                            // MODO VER RESOLUCIÓN
                            evaluationBlock.style.display = 'none';
                            viewResolutionBlock.style.display = 'block';
                            modalFooter.style.display = 'flex'; // Mantener footer para el botón "Cancelar"

                            const status = requestEstado;
                            const statusClass = status === 'ACEPTADO' || status === 'APROBADA' || status === 'ACEPTADO_CON_SUGERENCIAS' ? 'bg-success' : 'bg-danger';

                            viewResolutionBlock.querySelector('#view-status-badge').className = `badge ${statusClass}`;
                            viewResolutionBlock.querySelector('#view-status-badge').textContent = status;
                            viewResolutionBlock.querySelector('#view-detalle-text').textContent = requestData.detalle || 'El administrador no proporcionó comentarios adicionales.';
                        }

                        resolutionModal.show();
                    }
                });
                // --- FIN LÓGICA DE EVALUACIÓN Y MODAL ADMIN ---

                // Lógica para filtros (mantenida del código anterior)
                const adminFilterType = document.getElementById('admin-filter-type');
                const adminFilterStatus = document.getElementById('admin-filter-status');
            });
        </script>
    </div>
</body>
</html>